/*
 * Copyright (c) 2022 LG Electronics Inc.
 * SPDX-License-Identifier: Apache-2.0
 */

#include <aif/rppg/RppgPreProcessOperation.h>
#include <aif/rppg/RppgInferencePipeDescriptor.h>
#include <aif/log/Logger.h>
#include <aif/tools/Utils.h>
#include <aif/rppg/CubicSpline.h>
#include <aif/rppg/FiltFilt.h>
#include <aif/rppg/FftLib.h>

#include <cmath>
#include <iostream>
#include <vector>
#include <xtensor/xsort.hpp>
#include <xtensor/xio.hpp>
#include <xtensor/xindex_view.hpp>
#include <xtensor/xbuilder.hpp>
#include <xtensor/xview.hpp>
#include <xtensor/xadapt.hpp>
#include <xtensor/xmath.hpp>

namespace aif {

RppgPreProcessOperation::RppgPreProcessOperation(const std::string& id)
: BridgeOperation(id)
, m_fsRe(50)
, m_targetTime(8)
, m_winSec(1.6f)
{
}

RppgPreProcessOperation::~RppgPreProcessOperation()
{
}

bool RppgPreProcessOperation::runImpl(const std::shared_ptr<NodeInput>& input)
{
    auto& descriptor = input->getDescriptor();
    if (!descriptor) {
        Loge(m_id, ": failed to run operaiton (descriptor is null)");
        return false;
    }
    std::shared_ptr<RppgInferencePipeDescriptor> fdescriptor=
        std::dynamic_pointer_cast<RppgInferencePipeDescriptor>(input->getDescriptor());

    const cv::Mat& image = descriptor->getImage();
    if (image.empty()) {
        Loge("failed to get Image");
        return false;
    }
    // std::cout << "At rPPG Pre-Process: " << std::endl;
    // for(int i=0; i< 120; i++){
    //     std::cout << "Checking Input: " << image.at<double>(i, 0) << ", " << image.at<double>(i, 1) << ", " << image.at<double>(i, 2) << ", " << image.at<double>(i, 3) << std::endl;
    // }

    // std::cout << "Try this" << std::endl;
    // std::vector<double> image = {0.06589484214782715,164.74635713639245,125.29871481582043,103.12697981717803,
    //                                 0.06678462028503418,164.52125016936904,125.29438598075967,102.9441759631453,
    //                                 0.06593561172485352,164.9453497794184,125.31547672638877,103.27442153596832,
    //                                 0.06688809394836426,164.88551137648707,125.34853213914145,103.07947708870493,
    //                                 0.06748414039611816,165.64427257333762,125.66120543682212,103.46835385108233,
    //                                 0.06597161293029785,165.30149974928204,125.45489355882755,103.2338514837945,
    //                                 0.06612944602966309,165.24741655235482,125.25048010973937,103.13946044810243,
    //                                 0.06677007675170898,165.25513971828417,125.24821078543101,103.36276610293112,
    //                                 0.06689906120300293,165.2100128252107,124.90463539758153,103.43770611945767,
    //                                 0.06666278839111328,165.41855275741153,125.04931918575527,103.51659911653536,
    //                                 0.06677508354187012,165.67545327123932,125.19672649997739,103.86386037889406,
    //                                 0.06593799591064453,165.75572139303483,125.33613749434645,103.76933514246947,
    //                                 0.0668952465057373,165.49219786756967,125.38612547476319,103.63066855809271,
    //                                 0.06586313247680664,165.15605777555018,125.2442247231968,103.48024786986832,
    //                                 0.06770825386047363,165.32107664233575,125.34785583941606,103.48727189781022,
    //                                 0.06677961349487305,164.98286682853086,124.97736955426268,103.08223006092813,
    //                                 0.06582117080688477,164.99311445508437,124.6077975376197,103.01801185590516,
    //                                 0.0668635368347168,165.10502965276834,124.6588347141111,103.16922450088279,
    //                                 0.06594133377075195,165.14328480065316,124.35846146868055,102.97890869506055,
    //                                 0.06662940979003906,165.06802999318336,124.40472619859123,103.03885480572598,
    //                                 0.06777477264404297,165.24154195011337,124.54702947845804,103.39324263038549,
    //                                 0.06766080856323242,165.1569543331368,124.61956373860596,103.44165797469502,
    //                                 0.06586074829101562,165.14389304328122,124.5277588941763,103.562474507138,
    //                                 0.06670308113098145,165.25723121702748,124.91645442968893,103.69797162088412,
    //                                 0.06605839729309082,165.3138232760575,124.61531486602892,103.47377249852654,
    //                                 0.06677436828613281,165.2145864457422,124.65453393091585,103.48671284349676,
    //                                 0.06708455085754395,165.21843514568394,124.71176363801398,103.50272306435508,
    //                                 0.06691169738769531,165.43677056158177,125.03217538560118,103.5234106824111,
    //                                 0.06769442558288574,165.0831129752895,124.67219841342208,103.19271450715783,
    //                                 0.06676936149597168,165.04201872573648,124.88956382735785,102.97396665905458,
    //                                 0.0678396224975586,165.24493936251747,124.8537036202155,103.21604075560164,
    //                                 0.06602334976196289,164.96791685494804,124.79127880704925,103.18084048802531,
    //                                 0.06778669357299805,165.0784376136777,124.68433975991269,103.24904510731174,
    //                                 0.06665802001953125,165.42044218919898,124.81859369336716,103.14393802102211,
    //                                 0.06585216522216797,165.60662185027667,124.89715095806466,103.33722046920016,
    //                                 0.0677022933959961,165.70975687633992,124.9705788441363,103.40067509008803,
    //                                 0.06777548789978027,165.33562333974535,124.67161308051662,103.1306219657415,
    //                                 0.06703400611877441,165.35503312476996,124.67845969819653,103.48155134339345,
    //                                 0.06661128997802734,165.13067217251663,124.34209681119523,103.237439779766,
    //                                 0.06597661972045898,165.05575342465752,124.66698630136986,103.30730593607306,
    //                                 0.06781458854675293,165.03245417561823,124.65347168258901,103.36741783608356,
    //                                 0.06677675247192383,164.8973491773309,124.6268281535649,103.5219378427788,
    //                                 0.06773877143859863,164.69231465966215,124.2233594493003,103.36986549522214,
    //                                 0.06769776344299316,165.25563083684307,124.72857535249955,103.74285845083318,
    //                                 0.06677722930908203,165.49102599685446,124.65908039596633,103.48584512905911,
    //                                 0.06777548789978027,165.2261299565579,124.72941122100009,103.34208337184583,
    //                                 0.06777238845825195,165.4840291462353,124.64969524769717,103.46432335823289,
    //                                 0.06590485572814941,165.28627558479533,124.74725877192982,103.57396747076024,
    //                                 0.06587862968444824,165.58838821490468,124.90746146127884,103.67983216272918,
    //                                 0.06581997871398926,165.25477414616233,124.57735034887992,103.78745868527359,
    //                                 0.06764888763427734,165.7061803444782,124.78751036197845,103.6683245832182,
    //                                 0.06677699089050293,165.7273019813359,124.65168022801453,103.6987541948237,
    //                                 0.06603837013244629,165.68397249526973,124.64045410494255,103.88292030089067,
    //                                 0.06777381896972656,165.38391675414175,124.51348637670577,103.74985167267583,
    //                                 0.06677722930908203,165.2840536105033,124.35557986870897,103.5648249452954,
    //                                 0.0661466121673584,166.21899990807978,124.85228421729938,104.01001930324479,
    //                                 0.06592440605163574,166.17038965785025,124.79873007171898,103.64442008131195,
    //                                 0.06765985488891602,165.99136088755512,124.60469240212795,103.47101350429682,
    //                                 0.06699705123901367,166.35113076782784,124.81369688126938,103.38154295093926,
    //                                 0.06600499153137207,166.12400635930047,124.87980922098569,103.2317510788099,
    //                                 0.06677913665771484,166.19694760820045,124.9910250569476,103.4382687927107,
    //                                 0.0676567554473877,165.9461194232247,124.85901550422638,103.455317994847,
    //                                 0.06745314598083496,166.1251426224271,124.94153621468669,103.53895303728721,
    //                                 0.06689882278442383,166.43943506463634,125.19607121497907,103.4047476652712,
    //                                 0.0666651725769043,166.58341356072066,125.10186585980837,103.35258790629442,
    //                                 0.06688642501831055,166.415489393033,124.91739910726612,103.28065896645346,
    //                                 0.06692266464233398,166.28745254105485,124.98975344220301,103.24994282054801,
    //                                 0.06589317321777344,166.07134690144065,124.79345986736794,103.32499428310085,
    //                                 0.06665587425231934,165.71682393555812,124.93288837744534,103.65182968929804,
    //                                 0.06778240203857422,165.33010860637035,124.68002190380578,103.33179702473305,
    //                                 0.06589055061340332,165.4333257142857,124.83067428571428,103.43757714285714,
    //                                 0.06666731834411621,165.43265492796706,125.07505145209238,103.37877887034072,
    //                                 0.06692171096801758,165.46778391707383,125.15452760400018,103.36700305950043,
    //                                 0.06678295135498047,165.3288449207658,125.24049647339012,103.49093157460841,
    //                                 0.0677337646484375,165.84935279537316,125.28977324887542,103.49903607821537,
    //                                 0.06669974327087402,165.9167354424576,125.66382393397524,103.72640990371389,
    //                                 0.06777381896972656,165.90436571428572,125.44836571428571,103.72013714285714,
    //                                 0.06581425666809082,166.1413524235101,125.50102594500935,103.72267566458437,
    //                                 0.06688427925109863,166.3256143883575,125.45618049517185,104.00883254770949,
    //                                 0.0676577091217041,166.20325464130187,125.60165024066009,103.65794178317671,
    //                                 0.06589031219482422,165.94549247233812,125.60915109740613,103.63685833484492,
    //                                 0.06585407257080078,166.4625700376596,126.06668503720033,103.95894185726095,
    //                                 0.06770110130310059,166.45879926672777,125.8987167736022,104.03670944087993,
    //                                 0.06589317321777344,166.36048654625876,125.85329893107262,103.95019351271655,
    //                                 0.06677627563476562,166.36374505656212,125.79941138600202,104.07541616849076,
    //                                 0.06665658950805664,166.30613279270148,125.83804082384924,103.91521909413446,
    //                                 0.06588912010192871,165.865843583624,125.60069763172389,103.39599779695246,
    //                                 0.06689572334289551,166.22441610676904,125.84729649435532,103.72640431463961,
    //                                 0.06678175926208496,166.09240453981528,125.66930110738409,103.53402563984744,
    //                                 0.06776881217956543,165.83437599890405,125.63610210511895,103.43696059180785,
    //                                 0.06765627861022949,165.89003436426117,125.70167239404353,103.65214203894617,
    //                                 0.06580924987792969,166.11701492537313,125.66057405281286,103.62824339839266,
    //                                 0.06674790382385254,166.0866268382353,125.71856617647059,103.63639705882353,
    //                                 0.06677818298339844,165.28333949021055,125.29511451791652,102.99191909863318,
    //                                 0.06658148765563965,165.6133357995006,125.23467122907611,103.1699343382965,
    //                                 0.06765460968017578,165.73580054180633,125.53170485329905,103.54704072730613,
    //                                 0.06588459014892578,165.9932045118343,125.74015347633136,103.73511464497041,
    //                                 0.06766939163208008,166.36874281774305,125.71436451390485,103.9036083658929,
    //                                 0.06678628921508789,166.03040834057342,125.5385705793589,103.7091316475376,
    //                                 0.06677627563476562,165.68203983046985,125.41626031080527,103.52476871895365,
    //                                 0.06777310371398926,165.9758843909555,125.49927060539753,103.64245988329687,
    //                                 0.06588912010192871,165.8574428264938,125.5466289313918,103.59684119231297,
    //                                 0.0671074390411377,165.67349739273627,125.49844479004666,103.58677156710273,
    //                                 0.06579041481018066,165.95215901302262,125.74484806945397,103.80749371715787,
    //                                 0.06677603721618652,165.54941673555618,125.47869018094976,103.33967116744742,
    //                                 0.06726861000061035,165.8401992895696,125.66517507035107,103.58481339668774,
    //                                 0.06665849685668945,165.8463379827832,125.6098144823459,103.57666988905768,
    //                                 0.06620383262634277,165.99567079629716,125.6287938101598,103.48422603969972,
    //                                 0.06709146499633789,166.02860548271752,125.3993307050518,103.57233886494912,
    //                                 0.06677627563476562,165.68417672156718,125.3484883240813,103.3586732119099,
    //                                 0.06677675247192383,165.8673577030684,125.52020364170069,103.4326010182085,
    //                                 0.06678581237792969,165.86335574152832,125.72323592628162,103.37746375817441,
    //                                 0.06589293479919434,165.57377124063584,125.56020464096474,103.2690023752969,
    //                                 0.06777524948120117,165.6098833218943,125.64859299931366,103.31635781285748,
    //                                 0.06765985488891602,165.64041659053535,125.76685547231865,103.25602959985383,
    //                                 0.06777381896972656,165.42127059251843,125.57886593246565,103.14708291617366,
    //                                 0.06776571273803711,165.42740314327486,125.45065789473684,103.4047423245614,
    //                                 0.0668938159942627,165.48948453608247,125.4628636884307,103.65580756013746,
    //                                 0.06678271293640137,165.487583615871,125.36694767708238,103.49349399798406,
    //                                 0.06666326522827148,165.25034299826214,125.21028080124394,103.1365590414342
    //                                 };
    // std::vector<int> shape = {120, 4}; // rows=120, cols=4
    // xt::xarray<double> mesh_dataset = xt::adapt(image, shape); // total=480, channels=1
    // std::cout << "END" << std::endl;

    // Pre-Processing - Using XTENSOR
    std::vector<int> shape = {image.rows, image.cols}; // rows=120, cols=4
    xt::xarray<double> mesh_dataset = xt::adapt((double*)image.data, image.total() * image.channels(), xt::no_ownership(), shape); // total=480, channels=1
    xt::xarray<double> timeInfo = xt::cumsum(xt::view(mesh_dataset, xt::all(), 0)); // [120]
    xt::xarray<double> intrTime = xt::arange((1.0 / m_fsRe), (m_targetTime + 1.0 / m_fsRe), (1.0f / m_fsRe)); // [400]
    // CubicSpline Interpolation - AI Reseach Center
    xt::xarray<double> R_yNew, G_yNew, B_yNew;
    CubicSpline cubicSpline;
    for (int i = 0; i < 3; i++) {
        xt::xarray<double> RGB = xt::view(mesh_dataset, xt::all(), i+1); // [120]
        cubicSpline.CSpline( timeInfo.reshape({timeInfo.size()}), RGB.reshape({RGB.size()}) );

        if (i == 0) R_yNew = cubicSpline.CalcCSpline(intrTime); // [400]
        else if (i == 1) G_yNew = cubicSpline.CalcCSpline(intrTime); // [400]
        else B_yNew = cubicSpline.CalcCSpline(intrTime); // [400]
    }
    auto xt_rbgInter = xt::vstack(xt::xtuple(R_yNew, G_yNew, B_yNew)); // [3, 400]
    auto rgbInter = xt::transpose(xt_rbgInter); // [400, 3]

    int st_idx = -(m_targetTime * m_fsRe); // -400
    auto p_rgbInter = xt::view(rgbInter, xt::range(st_idx, xt::placeholders::_), xt::all()); // [400, 3]
    auto p_intrTime = xt::view(intrTime, xt::range(st_idx, xt::placeholders::_)); // [400]

    int N = static_cast<int>(p_intrTime.shape()[0]); // [400]
    xt::xarray<double> rPPGmDat = xt::zeros<double>({N}); // [400] == H
    int l = (int)std::ceil(m_winSec * m_fsRe); // 80
    // auto C = xt::zeros<double>({l, 3}); // [80, 3]
    xt::xarray<double> P = {{0.0, 1.0, -1.0}, {-2.0, 1.0, 1.0}}; // [2, 3]

    for (int n = 1; n < N; n++) {
        int m = n - l + 1;
        if (m > 0) {
            xt::xarray<double> p_p_rgbInter = xt::view(p_rgbInter, xt::range(m, n), xt::all()); // [79, 3]
            xt::xarray<double> m_p_rgbInter = xt::mean(p_p_rgbInter, {0});
            xt::xarray<double> Cn = xt::transpose(p_p_rgbInter / m_p_rgbInter); // [3, 79]
            auto S = dotProduct(P, Cn); // [2, 79]

            xt::xarray<double> S_first  = xt::view(S, 0, xt::all());
            xt::xarray<double> S_second = xt::view(S, 1, xt::all());
            double std_s_first  = xt::stddev(S_first)();
            double std_s_second = xt::stddev(S_second)();

            xt::xarray<double> h_ = xt::zeros<double>({S_first.shape()[0]});
            h_ = S_first + (std_s_first / std_s_second) * S_second;

            double h_mean = xt::mean(h_, {0})();
            int count = 0;
            for(int i = m; i < n; i++) {
                double h_update = h_(count++) - h_mean;
                rPPGmDat(i) = rPPGmDat(i) + h_update;
            }
        }
    }

    xt::xarray<double> greenDat = xt::view(p_rgbInter, xt::all(), 1); // [400]

    // Normalization
    double rPPGmDat_min = xt::amin(rPPGmDat)();
    double rPPGmDat_max = xt::amax(rPPGmDat)();
    double greenDat_min = xt::amin(greenDat)();
    double greenDat_max = xt::amax(greenDat)();
    xt::xarray<double> data11 = (rPPGmDat - rPPGmDat_min) / (rPPGmDat_max - rPPGmDat_min); // [400]
    xt::xarray<double> data21 = (greenDat - greenDat_min) / (greenDat_max - greenDat_min); // [400]

    xt::xarray<double> inputDat = xt::stack(xt::xtuple(data11, data21), 1); // [400, 2]
    xt::xarray<double> reshapeData = inputDat.reshape({1, inputDat.shape()[0], 2 }); // [1, 400, 2]
    xt::xarray<float> double_reshapeData = xt::cast<float>(reshapeData);

    cv::Mat cv_reshapeData(double_reshapeData.shape()[0], double_reshapeData.shape()[1], CV_32FC2, double_reshapeData.data());
    // std::cout << "Checking Input: " << std::endl;
    // for(int i=0; i< 400; i++){
    //     std::cout << cv_reshapeData.at<cv::Vec2f>(0, i)[0] << ", "<< cv_reshapeData.at<cv::Vec2f>(0, i)[1] << std::endl;
    // }

    // memoryDump(cv_reshapeData.data, "./swp_input.bin", 1* 400 * 2*sizeof(float));
    // memoryRestore(cv_reshapeData.data, "./swp_input.bin");
    descriptor->copyImage(cv_reshapeData);
    fdescriptor->addFirstInputXarray(data11); // for post-process

    return true;
}

xt::xarray<double> RppgPreProcessOperation::dotProduct(xt::xarray<double>& p, xt::xarray<double>& cn)
{
    xt::xarray<double> xt_output = xt::zeros<double>({p.shape()[0], cn.shape()[1]}); // [2, 79] | zero initialization
    // matrix x matrix dot product
    for (int i = 0; i < p.shape()[0]; i++) { // 2
        for(int j = 0; j < cn.shape()[1]; j++) { // 79
            for( int k = 0; k < p.shape()[1]; k++) { // 3
                xt_output(i, j) = xt_output(i, j) + p(i, k) * cn(k, j);
            }
        }
    }

    return xt_output;
}

} // end of namespace aif
