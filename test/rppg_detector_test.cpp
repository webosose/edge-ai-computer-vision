/*
 * Copyright (c) 2024 LG Electronics Inc.
 * SPDX-License-Identifier: Apache-2.0
 */

#include <aif/base/AIVision.h>
#include <aif/base/DetectorFactory.h>
#include <aif/base/DelegateFactory.h>
#include <aif/rppg/RppgDescriptor.h>
#include <aif/rppg/RppgDetector.h>

#include <aif/tools/Utils.h>
#include <aif/log/Logger.h>

#include <opencv2/opencv.hpp>
#include <opencv2/imgproc.hpp>

#include <gtest/gtest.h>
#include <iostream>
#include <fstream>

using namespace aif;

class RppgDetectorTest : public ::testing::Test
{
protected:
    RppgDetectorTest() = default;
    ~RppgDetectorTest() = default;

    static void SetUpTestCase()
    {
        AIVision::init();
    }

    static void TearDownTestCase()
    {
        AIVision::deinit();
    }


    void SetUp() override
    {
        DetectorFactory::get().clear();
        basePath = AIVision::getBasePath();
    }

    void TearDown() override
    {
    }

    std::string basePath;

    std::string use_npu_delegate {
        "{"
        "  \"delegates\" : ["
        "    {"
        "      \"name\": \"npu_delegate\","
        "      \"option\": {"
        "       }"
        "    }"
        "  ]"
        "}"};

    std::string use_cpu_delegate {
        "{"
        "  \"autoDelegate\" : {"
        "      \"policy\": \"CPU_ONLY\""
        "  }"
        "}"};
};

TEST_F(RppgDetectorTest, 01_rppg_cpu_init)
{
    auto fmd = std::dynamic_pointer_cast<RppgDetector>(DetectorFactory::get().getDetector("rppg_cpu", use_cpu_delegate));
    EXPECT_TRUE(fmd.get() != nullptr);
    EXPECT_EQ(fmd->getModelName(), "rPPG_cpu.tflite");
    auto modelInfo = fmd->getModelInfo();
    EXPECT_EQ(modelInfo.batchSize, 1);
    EXPECT_EQ(modelInfo.height, 200);
    EXPECT_EQ(modelInfo.width, 2);
}

TEST_F(RppgDetectorTest, 02_rppg_cpu_example_test)
{
    auto fmd = std::dynamic_pointer_cast<RppgDetector>(DetectorFactory::get().getDetector("rppg_cpu", use_cpu_delegate));
    EXPECT_TRUE(fmd.get() != nullptr);

    std::shared_ptr<Descriptor> descriptor = std::make_shared<RppgDescriptor>();
    std::vector<double> rppgData = {0.547621, 0.370028,
                                    0.548616, 0.414905,
                                    0.551445, 0.462935,
                                    0.555716, 0.505108,
                                    0.560532, 0.532415,
                                    0.564522, 0.535911,
                                    0.566533, 0.514579,
                                    0.567079, 0.482793,
                                    0.567852, 0.456699,
                                    0.57115, 0.450676,
                                    0.577466, 0.469545,
                                    0.586102, 0.514912,
                                    0.595913, 0.587527,
                                    0.60617, 0.675199,
                                    0.616636, 0.755665,
                                    0.627048, 0.806581,
                                    0.636252, 0.81964,
                                    0.641334, 0.810336,
                                    0.638648, 0.796463,
                                    0.625599, 0.792905,
                                    0.606534, 0.802766,
                                    0.588837, 0.826174,
                                    0.580657, 0.862447,
                                    0.582894, 0.902531,
                                    0.590986, 0.932435,
                                    0.599274, 0.938317,
                                    0.602695, 0.917681,
                                    0.597994, 0.884847,
                                    0.581755, 0.855498,
                                    0.553321, 0.840861,
                                    0.523174, 0.836822,
                                    0.505857, 0.83597,
                                    0.515374, 0.831898,
                                    0.545138, 0.827089,
                                    0.575584, 0.82865,
                                    0.585186, 0.843575,
                                    0.567388, 0.872985,
                                    0.537884, 0.910363,
                                    0.515486, 0.948688,
                                    0.513838, 0.980924,
                                    0.523754, 1,
                                    0.53002, 0.998834,
                                    0.518318, 0.971531,
                                    0.494019, 0.924445,
                                    0.475345, 0.871174,
                                    0.481582, 0.825321,
                                    0.515282, 0.795855,
                                    0.552063, 0.784855,
                                    0.563744, 0.793843,
                                    0.530156, 0.821829,
                                    0.469832, 0.857645,
                                    0.412684, 0.88754,
                                    0.387931, 0.898647,
                                    0.39631, 0.889161,
                                    0.417856, 0.864829,
                                    0.431502, 0.831626,
                                    0.427794, 0.7999,
                                    0.415752, 0.786497,
                                    0.40659, 0.808791,
                                    0.409391, 0.874225,
                                    0.421957, 0.950434,
                                    0.43819, 0.995083,
                                    0.451472, 0.969873,
                                    0.463476, 0.886497,
                                    0.48274, 0.79043,
                                    0.518985, 0.72747,
                                    0.572022, 0.719135,
                                    0.623149, 0.745718,
                                    0.651479, 0.783509,
                                    0.642269, 0.812725,
                                    0.606729, 0.829505,
                                    0.562187, 0.834019,
                                    0.524521, 0.826602,
                                    0.498445, 0.809616,
                                    0.481561, 0.786811,
                                    0.471776, 0.761973,
                                    0.467241, 0.739465,
                                    0.466235, 0.724639,
                                    0.467551, 0.722937,
                                    0.471754, 0.737349,
                                    0.487147, 0.760877,
                                    0.515911, 0.783988,
                                    0.559765, 0.797803,
                                    0.609026, 0.801656,
                                    0.649095, 0.800495,
                                    0.668409, 0.799338,
                                    0.664873, 0.800417,
                                    0.647405, 0.801205,
                                    0.623394, 0.798705,
                                    0.596725, 0.790068,
                                    0.566842, 0.77302,
                                    0.533533, 0.745435,
                                    0.498726, 0.705908,
                                    0.47424, 0.661957,
                                    0.477164, 0.627131,
                                    0.5232, 0.614939,
                                    0.612632, 0.627103,
                                    0.721634, 0.645327,
                                    0.825057, 0.649374,
                                    0.900651, 0.625687,
                                    0.934402, 0.587766,
                                    0.914794, 0.555965,
                                    0.833589, 0.548812,
                                    0.716766, 0.561906,
                                    0.612295, 0.575189,
                                    0.566499, 0.568458,
                                    0.591185, 0.533509,
                                    0.642638, 0.482522,
                                    0.673957, 0.429654,
                                    0.653292, 0.387221,
                                    0.601671, 0.360065,
                                    0.550873, 0.351135,
                                    0.528064, 0.362698,
                                    0.533757, 0.389306,
                                    0.553325, 0.420639,
                                    0.573152, 0.446456,
                                    0.585529, 0.46353,
                                    0.590135, 0.478376,
                                    0.587051, 0.498225,
                                    0.57741, 0.526468,
                                    0.56647, 0.552215,
                                    0.560415, 0.561257,
                                    0.564758, 0.541382,
                                    0.579041, 0.49928,
                                    0.599573, 0.452078,
                                    0.622697, 0.416781,
                                    0.644709, 0.399936,
                                    0.66184, 0.393563,
                                    0.670401, 0.388609,
                                    0.668063, 0.376994,
                                    0.656657, 0.353791,
                                    0.638678, 0.314709,
                                    0.616763, 0.256887,
                                    0.59618, 0.191203,
                                    0.583729, 0.136182,
                                    0.586035, 0.109944,
                                    0.600518, 0.114023,
                                    0.613364, 0.129771,
                                    0.610165, 0.137332,
                                    0.582089, 0.126019,
                                    0.535562, 0.110489,
                                    0.479378, 0.109744,
                                    0.422185, 0.139508,
                                    0.37399, 0.189204,
                                    0.345847, 0.235615,
                                    0.348582, 0.256121,
                                    0.375635, 0.245833,
                                    0.401247, 0.218796,
                                    0.398223, 0.189967,
                                    0.352767, 0.170461,
                                    0.284919, 0.162086,
                                    0.22028, 0.165269,
                                    0.180819, 0.179315,
                                    0.15984, 0.19581,
                                    0.138099, 0.203072,
                                    0.0967834, 0.18993,
                                    0.0405856, 0.158838,
                                    0, 0.126832,
                                    0.00736801, 0.111633,
                                    0.0766755, 0.122604,
                                    0.175562, 0.148806,
                                    0.263888, 0.176277,
                                    0.30769, 0.192789,
                                    0.313825, 0.196271,
                                    0.304529, 0.188337,
                                    0.301552, 0.17081,
                                    0.309904, 0.14893,
                                    0.320386, 0.13077,
                                    0.323225, 0.124453,
                                    0.315543, 0.13307,
                                    0.3091, 0.149197,
                                    0.317483, 0.1641,
                                    0.34975, 0.170148,
                                    0.388414, 0.166199,
                                    0.40639, 0.153465,
                                    0.37919, 0.133435,
                                    0.325756, 0.112245,
                                    0.301264, 0.0999063,
                                    0.36161, 0.106469,
                                    0.518509, 0.134504,
                                    0.703146, 0.172975,
                                    0.838084, 0.209404,
                                    0.865865, 0.233759,
                                    0.816005, 0.246728,
                                    0.741697, 0.251937,
                                    0.692865, 0.252761,
                                    0.678818, 0.249142,
                                    0.679521, 0.238503,
                                    0.674745, 0.218269,
                                    0.660278, 0.191428,
                                    0.660155, 0.171095,
                                    0.700651, 0.171465,
                                    0.795765, 0.201523,
                                    0.909341, 0.247436,
                                    0.992256, 0.289123,
                                    1, 0.307783,
                                    0.938384, 0.30207,
                                    0.849044, 0.28327,
                                    0.77383, 0.262899,
                                    0.734315, 0.249208,
                                  };

    cv::Mat rppg_mat(1, 200, CV_32FC2, rppgData.data());
    EXPECT_TRUE(fmd->detect(rppg_mat, descriptor) == aif::kAifOk);
}

TEST_F(RppgDetectorTest, 03_rppg_npu_init)
{
    auto fmd = std::dynamic_pointer_cast<RppgDetector>(DetectorFactory::get().getDetector("rppg_npu", use_npu_delegate));
    EXPECT_TRUE(fmd.get() != nullptr);
    EXPECT_EQ(fmd->getModelName(), "rPPG_npu.tflite");
    auto modelInfo = fmd->getModelInfo();
    EXPECT_EQ(modelInfo.batchSize, 1);
    EXPECT_EQ(modelInfo.height, 200);
    EXPECT_EQ(modelInfo.width, 2);
}

TEST_F(RppgDetectorTest, 02_rppg_npu_example_test)
{
    auto fmd = std::dynamic_pointer_cast<RppgDetector>(DetectorFactory::get().getDetector("rppg_npu", use_npu_delegate));
    EXPECT_TRUE(fmd.get() != nullptr);

    std::shared_ptr<Descriptor> descriptor = std::make_shared<RppgDescriptor>();
    std::vector<double> rppgData = {0.547621, 0.370028,
                                    0.548616, 0.414905,
                                    0.551445, 0.462935,
                                    0.555716, 0.505108,
                                    0.560532, 0.532415,
                                    0.564522, 0.535911,
                                    0.566533, 0.514579,
                                    0.567079, 0.482793,
                                    0.567852, 0.456699,
                                    0.57115, 0.450676,
                                    0.577466, 0.469545,
                                    0.586102, 0.514912,
                                    0.595913, 0.587527,
                                    0.60617, 0.675199,
                                    0.616636, 0.755665,
                                    0.627048, 0.806581,
                                    0.636252, 0.81964,
                                    0.641334, 0.810336,
                                    0.638648, 0.796463,
                                    0.625599, 0.792905,
                                    0.606534, 0.802766,
                                    0.588837, 0.826174,
                                    0.580657, 0.862447,
                                    0.582894, 0.902531,
                                    0.590986, 0.932435,
                                    0.599274, 0.938317,
                                    0.602695, 0.917681,
                                    0.597994, 0.884847,
                                    0.581755, 0.855498,
                                    0.553321, 0.840861,
                                    0.523174, 0.836822,
                                    0.505857, 0.83597,
                                    0.515374, 0.831898,
                                    0.545138, 0.827089,
                                    0.575584, 0.82865,
                                    0.585186, 0.843575,
                                    0.567388, 0.872985,
                                    0.537884, 0.910363,
                                    0.515486, 0.948688,
                                    0.513838, 0.980924,
                                    0.523754, 1,
                                    0.53002, 0.998834,
                                    0.518318, 0.971531,
                                    0.494019, 0.924445,
                                    0.475345, 0.871174,
                                    0.481582, 0.825321,
                                    0.515282, 0.795855,
                                    0.552063, 0.784855,
                                    0.563744, 0.793843,
                                    0.530156, 0.821829,
                                    0.469832, 0.857645,
                                    0.412684, 0.88754,
                                    0.387931, 0.898647,
                                    0.39631, 0.889161,
                                    0.417856, 0.864829,
                                    0.431502, 0.831626,
                                    0.427794, 0.7999,
                                    0.415752, 0.786497,
                                    0.40659, 0.808791,
                                    0.409391, 0.874225,
                                    0.421957, 0.950434,
                                    0.43819, 0.995083,
                                    0.451472, 0.969873,
                                    0.463476, 0.886497,
                                    0.48274, 0.79043,
                                    0.518985, 0.72747,
                                    0.572022, 0.719135,
                                    0.623149, 0.745718,
                                    0.651479, 0.783509,
                                    0.642269, 0.812725,
                                    0.606729, 0.829505,
                                    0.562187, 0.834019,
                                    0.524521, 0.826602,
                                    0.498445, 0.809616,
                                    0.481561, 0.786811,
                                    0.471776, 0.761973,
                                    0.467241, 0.739465,
                                    0.466235, 0.724639,
                                    0.467551, 0.722937,
                                    0.471754, 0.737349,
                                    0.487147, 0.760877,
                                    0.515911, 0.783988,
                                    0.559765, 0.797803,
                                    0.609026, 0.801656,
                                    0.649095, 0.800495,
                                    0.668409, 0.799338,
                                    0.664873, 0.800417,
                                    0.647405, 0.801205,
                                    0.623394, 0.798705,
                                    0.596725, 0.790068,
                                    0.566842, 0.77302,
                                    0.533533, 0.745435,
                                    0.498726, 0.705908,
                                    0.47424, 0.661957,
                                    0.477164, 0.627131,
                                    0.5232, 0.614939,
                                    0.612632, 0.627103,
                                    0.721634, 0.645327,
                                    0.825057, 0.649374,
                                    0.900651, 0.625687,
                                    0.934402, 0.587766,
                                    0.914794, 0.555965,
                                    0.833589, 0.548812,
                                    0.716766, 0.561906,
                                    0.612295, 0.575189,
                                    0.566499, 0.568458,
                                    0.591185, 0.533509,
                                    0.642638, 0.482522,
                                    0.673957, 0.429654,
                                    0.653292, 0.387221,
                                    0.601671, 0.360065,
                                    0.550873, 0.351135,
                                    0.528064, 0.362698,
                                    0.533757, 0.389306,
                                    0.553325, 0.420639,
                                    0.573152, 0.446456,
                                    0.585529, 0.46353,
                                    0.590135, 0.478376,
                                    0.587051, 0.498225,
                                    0.57741, 0.526468,
                                    0.56647, 0.552215,
                                    0.560415, 0.561257,
                                    0.564758, 0.541382,
                                    0.579041, 0.49928,
                                    0.599573, 0.452078,
                                    0.622697, 0.416781,
                                    0.644709, 0.399936,
                                    0.66184, 0.393563,
                                    0.670401, 0.388609,
                                    0.668063, 0.376994,
                                    0.656657, 0.353791,
                                    0.638678, 0.314709,
                                    0.616763, 0.256887,
                                    0.59618, 0.191203,
                                    0.583729, 0.136182,
                                    0.586035, 0.109944,
                                    0.600518, 0.114023,
                                    0.613364, 0.129771,
                                    0.610165, 0.137332,
                                    0.582089, 0.126019,
                                    0.535562, 0.110489,
                                    0.479378, 0.109744,
                                    0.422185, 0.139508,
                                    0.37399, 0.189204,
                                    0.345847, 0.235615,
                                    0.348582, 0.256121,
                                    0.375635, 0.245833,
                                    0.401247, 0.218796,
                                    0.398223, 0.189967,
                                    0.352767, 0.170461,
                                    0.284919, 0.162086,
                                    0.22028, 0.165269,
                                    0.180819, 0.179315,
                                    0.15984, 0.19581,
                                    0.138099, 0.203072,
                                    0.0967834, 0.18993,
                                    0.0405856, 0.158838,
                                    0, 0.126832,
                                    0.00736801, 0.111633,
                                    0.0766755, 0.122604,
                                    0.175562, 0.148806,
                                    0.263888, 0.176277,
                                    0.30769, 0.192789,
                                    0.313825, 0.196271,
                                    0.304529, 0.188337,
                                    0.301552, 0.17081,
                                    0.309904, 0.14893,
                                    0.320386, 0.13077,
                                    0.323225, 0.124453,
                                    0.315543, 0.13307,
                                    0.3091, 0.149197,
                                    0.317483, 0.1641,
                                    0.34975, 0.170148,
                                    0.388414, 0.166199,
                                    0.40639, 0.153465,
                                    0.37919, 0.133435,
                                    0.325756, 0.112245,
                                    0.301264, 0.0999063,
                                    0.36161, 0.106469,
                                    0.518509, 0.134504,
                                    0.703146, 0.172975,
                                    0.838084, 0.209404,
                                    0.865865, 0.233759,
                                    0.816005, 0.246728,
                                    0.741697, 0.251937,
                                    0.692865, 0.252761,
                                    0.678818, 0.249142,
                                    0.679521, 0.238503,
                                    0.674745, 0.218269,
                                    0.660278, 0.191428,
                                    0.660155, 0.171095,
                                    0.700651, 0.171465,
                                    0.795765, 0.201523,
                                    0.909341, 0.247436,
                                    0.992256, 0.289123,
                                    1, 0.307783,
                                    0.938384, 0.30207,
                                    0.849044, 0.28327,
                                    0.77383, 0.262899,
                                    0.734315, 0.249208,
                                  };

    cv::Mat rppg_mat(1, 200, CV_32FC2, rppgData.data());
    EXPECT_TRUE(fmd->detect(rppg_mat, descriptor) == aif::kAifOk);
}
